---
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: test-update-fbc-catalog-invalid-fragments-array
spec:
  description: Tests the pipeline error handling when fbcFragments parameter contains invalid JSON (not a JSON array).
    This test validates that the task fails gracefully with proper error message when given a malformed fbcFragments
    parameter that is not a valid JSON array format.
  tasks:
    - name: run-task
      taskRef:
        name: update-fbc-catalog-task
      params:
        - name: fbcFragments
          value: 'registry.io/image0@sha256:0000'  # Invalid - not a JSON array
        - name: fromIndex
          value: "quay.io/scoheb/fbc-index-testing:latest"
        - name: targetIndex
          value: "quay.io/fbc/catalog:test"
        - name: buildTags
          value: "[]"
        - name: addArches
          value: "[]"
        - name: iibServiceAccountSecret
          value: "iib-service-account-secret"
        - name: publishingCredentials
          value: "publishing-credentials"
    - name: check-result
      params:
        - name: jsonBuildInfo
          value: $(tasks.run-task.results.jsonBuildInfo)
        - name: buildState
          value: $(tasks.run-task.results.buildState)
        - name: genericResult
          value: $(tasks.run-task.results.genericResult)
        - name: indexImageDigests
          value: $(tasks.run-task.results.indexImageDigests)
        - name: iibLog
          value: $(tasks.run-task.results.iibLog)
        - name: exitCode
          value: $(tasks.run-task.results.exitCode)
      taskSpec:
        params:
          - name: jsonBuildInfo
            type: string
          - name: buildState
            type: string
          - name: genericResult
            type: string
          - name: indexImageDigests
            type: string
          - name: iibLog
            type: string
          - name: exitCode
            type: string
        steps:
          - name: check-result
            image: quay.io/konflux-ci/release-service-utils:7a1d88df0e5aa21f6219db2a8732af87eed7ed73
            env:
              - name: BUILD_STATE
                value: $(params.buildState)
              - name: GENERIC_RESULT
                value: $(params.genericResult)
              - name: JSON_BUILDINFO
                value: $(params.jsonBuildInfo)
            script: |
              #!/bin/bash
              set -x

              # This test expects the task to fail due to invalid JSON array
              if [ "$(params.exitCode)" = "0" ]; then
                echo "The task should have failed with invalid fbcFragments parameter but succeeded"
                exit 1
              fi

              # The task should fail early due to JSON validation, so most results should be empty
              if [ "$(params.exitCode)" != "1" ]; then
                echo "The task did not exit with the expected error code (expected: 1, got: $(params.exitCode))"
                exit 1
              fi

              # Check that the task failed early and didn't proceed to IIB API call
              # The JSON_BUILDINFO should be empty or contain error information
              if [ -n "${JSON_BUILDINFO}" ] && [ "${JSON_BUILDINFO}" != "null" ] && [ "${JSON_BUILDINFO}" != "" ]; then
                # If there's build info, it shouldn't be a successful IIB response
                if jq -e '.id' <<< "${JSON_BUILDINFO}" >/dev/null 2>&1; then
                  echo "The task should not have made a successful IIB API call with invalid fbcFragments"
                  exit 1
                fi
              fi

              echo "Task correctly failed with invalid fbcFragments JSON array parameter"
      runAfter:
        - run-task