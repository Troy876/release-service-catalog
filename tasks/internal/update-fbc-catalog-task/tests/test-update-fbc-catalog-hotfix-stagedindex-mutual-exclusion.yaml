---
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: test-update-fbc-catalog-hotfix-stagedindex-mutual-exclusion
spec:
  description: |
    Tests the pipeline behavior when both hotfix and stagedIndex are set to true.
    This test validates the business logic where hotfix and stagedIndex parameters
    have mutual exclusion behavior - hotfix takes precedence over stagedIndex settings.
  tasks:
    - name: run-task
      taskRef:
        name: update-fbc-catalog-task
      params:
        - name: fbcFragments
          value: '["registry.io/image0@sha256:0000"]'
        - name: fromIndex
          value: "quay.io/scoheb/fbc-index-testing:latest"
        - name: targetIndex
          value: "quay.io/fbc/catalog:test"
        - name: buildTags
          value: "[]"
        - name: addArches
          value: "[]"
        - name: iibServiceAccountSecret
          value: "iib-service-account-secret"
        - name: publishingCredentials
          value: "publishing-credentials"
        - name: hotfix
          value: "true"  # Hotfix enabled
        - name: stagedIndex
          value: "true"  # Staged index also set - should be overridden by hotfix
    - name: check-result
      params:
        - name: jsonBuildInfo
          value: $(tasks.run-task.results.jsonBuildInfo)
        - name: buildState
          value: $(tasks.run-task.results.buildState)
        - name: genericResult
          value: $(tasks.run-task.results.genericResult)
        - name: indexImageDigests
          value: $(tasks.run-task.results.indexImageDigests)
        - name: iibLog
          value: $(tasks.run-task.results.iibLog)
        - name: exitCode
          value: $(tasks.run-task.results.exitCode)
      taskSpec:
        params:
          - name: jsonBuildInfo
            type: string
          - name: buildState
            type: string
          - name: genericResult
            type: string
          - name: indexImageDigests
            type: string
          - name: iibLog
            type: string
          - name: exitCode
            type: string
        steps:
          - name: check-result
            image: quay.io/konflux-ci/release-service-utils:7a1d88df0e5aa21f6219db2a8732af87eed7ed73
            env:
              - name: BUILD_STATE
                value: $(params.buildState)
              - name: GENERIC_RESULT
                value: $(params.genericResult)
              - name: JSON_BUILDINFO
                value: $(params.jsonBuildInfo)
            script: |
              #!/bin/bash
              set -x

              # Verify the task completed successfully
              state="$(jq -cr .state <<< "${BUILD_STATE}")"
              if [ "$state" != "complete" ]; then
                echo "The task did not save a completed IIB build in buildState result"
                exit 1
              fi

              # Verify hotfix behavior takes precedence: 
              # fbc_opt_in=true, overwrite_fromindex_image=false, publish_index_image=true, sign_index_image=true
              # This is the expected hotfix behavior regardless of stagedIndex setting
              genericResult=$(jq -cr \
                '. |[.fbc_opt_in, .overwrite_fromindex_image, .publish_index_image,.sign_index_image] |@csv' \
                <<< "${GENERIC_RESULT}")
              if [ "$genericResult" != '"true","false","true","true"' ]; then
                echo "The task did not save the correct hotfix values in genericResult result"
                echo "Expected: \"true\",\"false\",\"true\",\"true\""
                echo "Actual: $genericResult"
                exit 1
              fi

              if [ "$(params.exitCode)" != "0" ]; then
                echo "The task did not finish with a successful exit code"
                exit 1
              fi

              echo "SUCCESS: Hotfix behavior correctly overrides stagedIndex settings"
      runAfter:
        - run-task