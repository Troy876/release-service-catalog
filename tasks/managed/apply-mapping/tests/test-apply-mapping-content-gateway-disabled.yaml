---
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: test-apply-mapping-content-gateway-disabled
spec:
  description: |
    Run the apply-mapping task with a snapshot.spec json and no default configuration for content gateway and no
    configuration data for any of the components. The resulting snapshot should have no contentGateway data present
    for the component.
  workspaces:
    - name: tests-workspace
  tasks:
    - name: setup
      workspaces:
        - name: config
          workspace: tests-workspace
      taskSpec:
        workspaces:
          - name: config
        steps:
          - name: setup-values
            image: quay.io/konflux-ci/release-service-utils:e85ceb962ee6f4d0672b4aa4e9946621ab302f20
            script: |
              #!/usr/bin/env sh
              set -eux

              cat > "$(workspaces.config.path)/test_data.json" << EOF
              {
                "mapping": {
                  "components": [
                    {
                      "name": "comp1"
                    }
                  ]
                }
              }
              EOF

              cat > "$(workspaces.config.path)/test_snapshot_spec.json" << EOF
              {
                "application": "myapp",
                "components": [
                  {
                    "name": "comp1",
                    "containerImage": "registry.io/image1@sha256:123456",
                    "source": {
                      "git": {
                        "revision": "testrevision",
                        "url": "myurl"
                      }
                    }
                  }
                ]
              }
              EOF
    - name: run-task
      taskRef:
        name: apply-mapping
      params:
        - name: snapshotPath
          value: test_snapshot_spec.json
        - name: dataPath
          value: test_data.json
      runAfter:
        - setup
      workspaces:
        - name: config
          workspace: tests-workspace
    - name: check-result
      workspaces:
        - name: config
          workspace: tests-workspace
      taskSpec:
        workspaces:
          - name: config
        steps:
          - name: check-result
            image: quay.io/konflux-ci/release-service-utils:e85ceb962ee6f4d0672b4aa4e9946621ab302f20
            script: |
              #!/usr/bin/env bash
              set -eux

              cat "$(workspaces.config.path)/test_snapshot_spec.json"

              echo Test that comp1 has NO contentGateway data
              test "$(
                jq -c '.components[] | select(.name=="comp1") | has("contentGateway")' \
                < "$(workspaces.config.path)/test_snapshot_spec.json"
              )" == "false"

      runAfter:
        - run-task
